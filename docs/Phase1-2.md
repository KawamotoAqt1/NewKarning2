提供された考察を踏まえ、現在の実装との関連を確認中です。


[3 tools called]


提供された考察を踏まえ、現在の実装との関連を整理します。

## 現在の実装の状況

### 実装されている点
1. **未学習ペアの3つのアルゴリズム**
   - 平均値使用
   - Phase0フォールバック
   - Phase0 × 係数（文字列全体の幅を考慮）

2. **学習データの扱い**
   - `gap_norm_avg`を直接使用（絶対値アプローチ）
   - ペア単位での最適化に集中

### まだ実装されていない点
1. **差分学習アプローチ**
   - 現在は`gap_actual`を直接学習
   - Phase0からの差分`δ`を学習する仕組みは未実装

2. **幅アンカー**
   - アルゴリズム3は幅の比率で係数を計算しているが、提案の「全ギャップに均等割り」とは異なる

3. **Phase0とのブレンド**
   - ブレンド機能は未実装

## 考察

### 1. 問題の本質について

考察の指摘は妥当です。現在の実装は：
- 学習済みペア: `gap_norm_avg`を直接使用 → ペア単位では適切
- 未学習ペア: 平均値やPhase0ベース → バラつきが発生しやすい
- 文字列全体の幅: Phase0との整合性が保証されていない

### 2. 提案されている解決策の評価

#### ① 差分学習（Phase0からの差分δ）
- メリット: Phase0からの乖離を抑制し、暴走を防げる
- 実装難易度: 中（学習プロセスの変更が必要）
- 優先度: 高（根本的な改善）

#### ② 幅アンカー（全ギャップに均等割り）
- メリット: 実装が簡単で効果が明確
- 実装難易度: 低（`computeKerningPositions`の後処理で実現可能）
- 優先度: 高（即効性がある）

現在のアルゴリズム3は幅の比率で係数を計算していますが、これは「未学習ペアのみ」に適用されます。提案の「幅アンカー」は全ペアに均等に適用するため、より効果的です。

#### ③ Phase0とのブレンド
- メリット: 安全に学習効果を取り入れられる
- 実装難易度: 低（係数αを追加するだけ）
- 優先度: 中（調整の幅が広がる）

### 3. 現在のアルゴリズム3との関係

現在のアルゴリズム3（Phase0 × 係数）は、未学習ペアに対して文字列全体の幅を考慮した係数を適用しています。これは提案の「幅アンカー」とは異なるアプローチです。

- 現在のアプローチ: 未学習ペアのみに幅比率を適用
- 提案のアプローチ: 全ペアに均等に幅差分を分配

提案のアプローチの方が、文字列全体の幅をPhase0と揃えやすいです。

### 4. 実装の優先順位

即効性と効果を考慮した優先順位：

1. 幅アンカー（全ギャップ均等割り）
   - 実装が簡単で効果が明確
   - Phase1の範囲で実装可能

2. Phase0とのブレンド
   - ユーザーが調整可能にできる
   - 幅アンカーと併用可能

3. 差分学習
   - 学習プロセスの変更が必要
   - Phase2以降で検討してもよい

### 5. 実装上の注意点

#### 幅アンカーの実装
```javascript
// computeKerningPositions関数の最後で
const phase0Width = /* Phase0で計算した幅 */;
const phase1Width = /* Phase1で計算した幅 */;
const deltaW = phase1Width - phase0Width;
const adjust = -deltaW / (text.length - 1);  // ギャップ数で割る

// すべてのgapにadjustを加算
gaps = gaps.map(gap => gap + adjust);
```

#### Phase0とのブレンド
```javascript
// getKerningPhase1関数内で
const alpha = 0.5;  // ブレンド係数（調整可能）
const gapPhase0 = getKerningPhase0(...);
const gapPhase1 = /* Phase1で計算したgap */;
const gapFinal = (1 - alpha) * gapPhase0 + alpha * gapPhase1;
```

### 6. 結論

- 現在の実装は未学習ペアへの対応を用意しているが、文字列全体の幅の整合性は不十分
- 提案の「幅アンカー」は即効性が高く、Phase1の範囲で実装可能
- 「差分学習」は根本的な改善だが、Phase2以降でも検討可能
- 「Phase0とのブレンド」は幅アンカーと併用すると効果的

まずは「幅アンカー」を実装し、次に「Phase0とのブレンド」を追加するのが現実的です。これにより、Phase1の範囲で「学習済みペアが改善され、未学習ペアも破綻せず、文字列全体の幅もPhase0から極端にズレない」状態を実現できます。